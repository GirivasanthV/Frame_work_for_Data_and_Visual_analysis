<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loan Prediction Analysis Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <script>
        // Check if Plotly loaded
        window.addEventListener('load', function () {
            if (typeof Plotly === 'undefined') {
                console.error('Plotly failed to load!');
                // Try to load from alternative CDN
                const script = document.createElement('script');
                script.src = 'https://unpkg.com/plotly.js@2.26.0/dist/plotly.min.js';
                document.head.appendChild(script);
            } else {
                console.log('Plotly loaded successfully');
            }
        });
    </script>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <h1><i class="fas fa-chart-line"></i> Loan Prediction Analysis Dashboard</h1>
                <p>Comprehensive Data-Driven Framework for Loan Approval Assessment</p>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="nav-tabs">
            <button class="tab-button active" onclick="showTab('dashboard')">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </button>
            <button class="tab-button" onclick="showTab('prediction')">
                <i class="fas fa-calculator"></i> Loan Prediction
            </button>
            <button class="tab-button" onclick="showTab('analytics')">
                <i class="fas fa-chart-bar"></i> Analytics
            </button>
            <button class="tab-button" onclick="showTab('insights')">
                <i class="fas fa-lightbulb"></i> Insights
            </button>
        </nav>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-file-alt"></i>
                    </div>
                    <div class="stat-info">
                        <h3>{{ insights.total_applications or 0 }}</h3>
                        <p>Total Applications</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-info">
                        <h3>{{ "%.1f"|format(insights.approval_rate or 0) }}%</h3>
                        <p>Approval Rate</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                    <div class="stat-info">
                        <h3>₹{{ "%.0f"|format((insights.avg_loan_amount or 0) * 83) }}K</h3>
                        <p>Avg Loan Amount</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-wallet"></i>
                    </div>
                    <div class="stat-info">
                        <h3>₹{{ "%.0f"|format((insights.avg_applicant_income or 0) * 83 / 1000) }}K</h3>
                        <p>Avg Income</p>
                    </div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-container">
                    <div id="loan-status-pie"></div>
                </div>
                <div class="chart-container">
                    <div id="credit-history-bar"></div>
                </div>
                <div class="chart-container">
                    <div id="property-area-bar"></div>
                </div>
                <div class="chart-container">
                    <div id="loan-amount-hist"></div>
                </div>
            </div>
        </div>

        <!-- Prediction Tab -->
        <div id="prediction" class="tab-content">
            <div class="prediction-container">
                <div class="prediction-form">
                    <h2><i class="fas fa-calculator"></i> Loan Prediction Form</h2>
                    <form id="loan-form">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="gender">Gender</label>
                                <select id="gender" name="Gender" required>
                                    <option value="">Select Gender</option>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="married">Married</label>
                                <select id="married" name="Married" required>
                                    <option value="">Select Status</option>
                                    <option value="Yes">Yes</option>
                                    <option value="No">No</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="dependents">Dependents</label>
                                <select id="dependents" name="Dependents" required>
                                    <option value="">Select Dependents</option>
                                    <option value="0">0</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3+">3+</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="education">Education</label>
                                <select id="education" name="Education" required>
                                    <option value="">Select Education</option>
                                    <option value="Graduate">Graduate</option>
                                    <option value="Not Graduate">Not Graduate</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="self_employed">Self Employed</label>
                                <select id="self_employed" name="Self_Employed" required>
                                    <option value="">Select Status</option>
                                    <option value="Yes">Yes</option>
                                    <option value="No">No</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="applicant_income">Applicant Income (₹)</label>
                                <input type="number" id="applicant_income" name="ApplicantIncome" required min="0"
                                    step="1" placeholder="e.g., 500000">
                            </div>

                            <div class="form-group">
                                <label for="coapplicant_income">Coapplicant Income (₹)</label>
                                <input type="number" id="coapplicant_income" name="CoapplicantIncome" required min="0"
                                    step="1" value="0" placeholder="e.g., 200000">
                            </div>

                            <div class="form-group">
                                <label for="loan_amount">Loan Amount (₹ in thousands)</label>
                                <input type="number" id="loan_amount" name="LoanAmount" required min="1" step="1"
                                    placeholder="e.g., 5000 (for ₹50 lakhs)">
                            </div>

                            <div class="form-group">
                                <label for="loan_term">Loan Term (months)</label>
                                <select id="loan_term" name="Loan_Amount_Term" required>
                                    <option value="">Select Term</option>
                                    <option value="60">60</option>
                                    <option value="84">84</option>
                                    <option value="120">120</option>
                                    <option value="180">180</option>
                                    <option value="240">240</option>
                                    <option value="300">300</option>
                                    <option value="360">360</option>
                                    <option value="480">480</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="credit_history">Credit History</label>
                                <select id="credit_history" name="Credit_History" required>
                                    <option value="">Select Status</option>
                                    <option value="1">Yes</option>
                                    <option value="0">No</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="property_area">Property Area</label>
                                <select id="property_area" name="Property_Area" required>
                                    <option value="">Select Area</option>
                                    <option value="Urban">Urban</option>
                                    <option value="Semiurban">Semiurban</option>
                                    <option value="Rural">Rural</option>
                                </select>
                            </div>
                        </div>

                        <button type="submit" class="predict-btn">
                            <i class="fas fa-magic"></i> Predict Loan Approval
                        </button>
                    </form>
                </div>

                <div class="prediction-result" id="prediction-result" style="display: none;">
                    <h3>Prediction Result</h3>
                    <div id="result-content"></div>
                </div>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div id="analytics" class="tab-content">
            <div class="analytics-container">
                <h2><i class="fas fa-chart-bar"></i> Advanced Analytics</h2>
                <div class="charts-grid">
                    <div class="chart-container large">
                        <div id="income-loan-scatter"></div>
                    </div>
                    <div class="chart-container">
                        <div id="feature-importance"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Insights Tab -->
        <div id="insights" class="tab-content">
            <div class="insights-container">
                <h2><i class="fas fa-lightbulb"></i> Key Insights & Recommendations</h2>

                <div class="insights-grid">
                    <div class="insight-card">
                        <div class="insight-header">
                            <i class="fas fa-credit-card"></i>
                            <h3>Credit History Impact</h3>
                        </div>
                        <p>Applicants with credit history have significantly higher approval rates. Credit history is
                            one of the strongest predictors of loan approval.</p>
                    </div>

                    <div class="insight-card">
                        <div class="insight-header">
                            <i class="fas fa-home"></i>
                            <h3>Property Area Analysis</h3>
                        </div>
                        <p>Semiurban properties show the highest approval rates, followed by urban areas. Rural
                            properties have slightly lower approval rates.</p>
                    </div>

                    <div class="insight-card">
                        <div class="insight-header">
                            <i class="fas fa-graduation-cap"></i>
                            <h3>Education Factor</h3>
                        </div>
                        <p>Graduate applicants generally have higher approval rates, indicating education level as a
                            positive factor in loan decisions.</p>
                    </div>

                    <div class="insight-card">
                        <div class="insight-header">
                            <i class="fas fa-chart-line"></i>
                            <h3>Income Patterns</h3>
                        </div>
                        <p>Higher total income (applicant + coapplicant) correlates with better approval chances.
                            Typical approved applicants have ₹4-6 lakhs annual income.</p>
                    </div>

                    <div class="insight-card">
                        <div class="insight-header">
                            <i class="fas fa-users"></i>
                            <h3>Marital Status</h3>
                        </div>
                        <p>Married applicants tend to have higher approval rates, possibly due to combined income and
                            perceived stability.</p>
                    </div>

                    <div class="insight-card">
                        <div class="insight-header">
                            <i class="fas fa-briefcase"></i>
                            <h3>Employment Type</h3>
                        </div>
                        <p>Self-employed applicants face slightly more scrutiny, but with good credit history and
                            income, approval rates remain competitive.</p>
                    </div>
                </div>

                <div class="recommendations">
                    <h3><i class="fas fa-star"></i> Recommendations for Loan Applicants (Indian Context)</h3>
                    <ul>
                        <li>Maintain a good credit history - it's the most important factor for Indian banks</li>
                        <li>Include coapplicant income to improve total household income (aim for ₹5+ lakhs combined)
                        </li>
                        <li>Consider semiurban or urban properties for better approval chances</li>
                        <li>Keep loan amount under 6-8 times your annual income (EMI should be <40% of income)</li>
                        <li>Graduate degree holders have ~10% higher approval rates in Indian banking</li>
                        <li>Married applicants with stable employment show better approval rates</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Tab switching functionality
        function showTab(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(tab => tab.classList.remove('active'));

            // Remove active class from all buttons
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(btn => btn.classList.remove('active'));

            // Show selected tab and activate button
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // Initialize plots
        document.addEventListener('DOMContentLoaded', function () {
            console.log('DOM loaded, initializing plots...');

            // Always fetch plots dynamically to ensure they load
            fetch('/api/plots')
                .then(response => {
                    console.log('Plots API response status:', response.status);
                    return response.json();
                })
                .then(plots => {
                    console.log('Fetched plots:', Object.keys(plots));

                    // Render each plot
                    Object.keys(plots).forEach(plotName => {
                        const elementId = plotName.replace(/_/g, '-');
                        const element = document.getElementById(elementId);
                        console.log(`Checking element ${elementId}:`, element ? 'found' : 'not found');

                        if (element) {
                            try {
                                console.log(`Rendering plot: ${elementId}`);
                                const plotData = JSON.parse(plots[plotName]);

                                Plotly.newPlot(elementId, plotData.data, plotData.layout || {}, {
                                    responsive: true,
                                    displayModeBar: true
                                }).then(() => {
                                    console.log(`Successfully rendered: ${elementId}`);
                                }).catch(error => {
                                    console.error(`Plotly render error for ${elementId}:`, error);
                                });

                            } catch (error) {
                                console.error(`Error parsing/rendering plot ${elementId}:`, error);
                            }
                        } else {
                            console.warn(`Element not found: ${elementId}`);
                        }
                    });
                })
                .catch(error => {
                    console.error('Error fetching plots:', error);
                });
        });

        // Loan prediction form handling
        document.getElementById('loan-form').addEventListener('submit', function (e) {
            e.preventDefault();

            const formData = new FormData(this);
            const data = {};

            for (let [key, value] of formData.entries()) {
                // Convert numeric fields (values are already in INR from the form)
                if (['ApplicantIncome', 'CoapplicantIncome', 'LoanAmount', 'Loan_Amount_Term', 'Credit_History'].includes(key)) {
                    data[key] = parseFloat(value);
                } else {
                    data[key] = value;
                }
            }

            // Show loading
            const resultDiv = document.getElementById('prediction-result');
            const resultContent = document.getElementById('result-content');
            resultContent.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Predicting...</div>';
            resultDiv.style.display = 'block';

            // Make prediction request
            fetch('/predict', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
                .then(response => response.json())
                .then(result => {
                    if (result.error) {
                        resultContent.innerHTML = `<div class="error"><i class="fas fa-exclamation-triangle"></i> Error: ${result.error}</div>`;
                    } else {
                        const isApproved = result.prediction === 'Y';
                        const confidence = (result.confidence * 100).toFixed(1);
                        const approvedProb = (result.probability.approved * 100).toFixed(1);

                        resultContent.innerHTML = `
                        <div class="result ${isApproved ? 'approved' : 'rejected'}">
                            <div class="result-header">
                                <i class="fas ${isApproved ? 'fa-check-circle' : 'fa-times-circle'}"></i>
                                <h4>Loan ${isApproved ? 'APPROVED' : 'REJECTED'}</h4>
                            </div>
                            <div class="result-details">
                                <p><strong>Confidence:</strong> ${confidence}%</p>
                                <p><strong>Approval Probability:</strong> ${approvedProb}%</p>
                                <div class="probability-bar">
                                    <div class="probability-fill" style="width: ${approvedProb}%"></div>
                                </div>
                            </div>
                        </div>
                    `;
                    }
                })
                .catch(error => {
                    resultContent.innerHTML = `<div class="error"><i class="fas fa-exclamation-triangle"></i> Error: ${error.message}</div>`;
                });
        });

        // Responsive plot resizing
        window.addEventListener('resize', function () {
            // Resize all plotly charts
            const plotElements = ['loan-status-pie', 'credit-history-bar', 'property-area-bar', 'loan-amount-hist', 'income-loan-scatter', 'feature-importance'];
            plotElements.forEach(elementId => {
                const element = document.getElementById(elementId);
                if (element && element.querySelector('.plotly-graph-div')) {
                    Plotly.Plots.resize(elementId);
                }
            });
        });
    </script>
</body>

</html>